<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - معرض الورسلين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* حل مشكلة عرض الموبايل */
@media (max-width: 768px) {
    /* جعل المودال عمودياً */
    .modal-content {
        grid-template-columns: 1fr !important;
        width: 95% !important;
        max-height: 95vh;
    }

    /* منع الجداول من تخريب عرض الصفحة */
    .section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        display: block;
        width: 100%;
    }
    
    /* تصغير العناوين لتناسب الشاشة */
    .hero h1 {
        font-size: 1.8rem !important;
    }
}
        :root { --primary-color: #1a1a1a; --secondary-color: #c9a961; --bg-light: #f9f8f6; --danger: #e74c3c; --success: #27ae60; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-light); margin: 0; line-height: 1.6; }
        
        /* تسجيل الدخول */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #1a1a1a; }
        .login-box { background: white; padding: 2.5rem; border-radius: 15px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 0.8rem; margin: 1rem 0; border: 1px solid #ddd; border-radius: 8px; text-align: center; }
        
        /* لوحة التحكم */
        .admin-container { display: none; }
        header { background: var(--primary-color); color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; }
        nav { background: white; padding: 1rem 5%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; gap: 10px; flex-wrap: wrap; }
        nav button { padding: 0.7rem 1.5rem; border: 1px solid var(--primary-color); background: none; cursor: pointer; border-radius: 20px; font-weight: 600; transition: 0.3s; }
        nav button.active { background: var(--primary-color); color: white; }

        .section { display: none; max-width: 1200px; margin: 0 auto; padding: 0 20px 50px; }
        .section.active { display: block; }
        
        form { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        input, textarea, select { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--secondary-color); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        th, td { padding: 1rem; text-align: right; border-bottom: 1px solid #eee; }
        th { background: #f4f4f4; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 15px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 10px; left: 10px; font-size: 24px; cursor: pointer; background: none; border: none; }
        
        #imagePreview, #editImagePreview { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-img { width: 70px; height: 70px; object-fit: cover; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>

<body>
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h2>تسجيل دخول الإدارة</h2>
            <input type="password" id="passwordInput" placeholder="كلمة المرور">
            <button class="btn btn-primary" style="width:100%" onclick="login()">دخول</button>
            <p id="errorMsg" style="color:red; display:none; margin-top:10px;">كلمة المرور خطأ!</p>
        </div>
    </div>

    <div class="admin-container" id="adminPanel">
        <header>
            <h3>لوحة التحكم</h3>
            <button class="btn btn-danger" onclick="logout()">خروج</button>
        </header>

        <nav>
            <button class="active" onclick="showSection('products')">قائمة المنتجات</button>
            <button onclick="showSection('addProduct')">إضافة منتج جديد</button>
            <button onclick="showSection('categories')">إدارة الفئات</button>
        </nav>

        <div class="admin-content">
            <div class="section active" id="productsSection">
                <table>
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>الاسم</th>
                            <th>السعر</th>
                            <th>الفئة</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody"></tbody>
                </table>
            </div>

            <div class="section" id="addProductSection">
                <form id="addProductForm">
                    <div class="form-group">
                        <label>اسم المنتج</label>
                        <input type="text" id="productName" required>
                    </div>
                    <div class="form-group">
                        <label>الفئة</label>
                        <select id="productCategory" required></select>
                    </div>
                    <div class="form-group">
                        <label>السعر (د.ع)</label>
                        <input type="number" id="productPrice" required>
                    </div>
                    <div class="form-group">
                        <label>الكمية</label>
                        <input type="number" id="productQuantity" value="0">
                    </div>
                    <div class="form-group">
                        <label>صور المنتج (من الجهاز - متعدد)</label>
                        <input type="file" id="productImages" multiple accept="image/*">
                        <div id="imagePreview"></div>
                    </div>
                    <div class="form-group">
                        <label>الوصف</label>
                        <textarea id="productDesc"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success" id="submitBtn">إضافة المنتج</button>
                </form>
            </div>

            <div class="section" id="categoriesSection">
                <form id="addCategoryForm" style="margin-bottom: 20px;">
                    <label>اسم الفئة الجديدة</label>
                    <input type="text" id="categoryName" required style="margin-bottom:10px">
                    <button type="submit" class="btn btn-primary">حفظ الفئة</button>
                </form>
                <div id="categoriesList"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeEditModal()">✕</button>
            <h3>تعديل المنتج</h3>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label>اسم المنتج</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label>الفئة</label>
                    <select id="editProductCategory" required></select>
                </div>
                <div class="form-group">
                    <label>السعر</label>
                    <input type="number" id="editProductPrice" required>
                </div>
                <div class="form-group">
                    <label>الكمية</label>
                    <input type="number" id="editProductQuantity">
                </div>
                <div class="form-group">
                    <label>معاينة الصور (القديمة / الجديدة)</label>
                    <div id="editImagePreview"></div>
                    <input type="file" id="editProductImages" multiple accept="image/*" style="margin-top:10px;">
                    <p style="font-size: 11px; color: #666;">* اترك الحقل فارغاً إذا لم ترد تغيير الصور.</p>
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="editProductDesc"></textarea>
                </div>
                <button type="submit" class="btn btn-success" id="updateBtn">حفظ التغييرات</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2PjI168hiMnqOW1zMxpsmgx1V4zzrsnI",
            authDomain: "digital-home-6e0d5.firebaseapp.com",
            databaseURL: "https://digital-home-6e0d5-default-rtdb.firebaseio.com",
            projectId: "digital-home-6e0d5",
            storageBucket: "digital-home-6e0d5.firebasestorage.app",
            messagingSenderId: "698649453097",
            appId: "1:698649453097:web:53330e14bfbac890f93238"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.login = function() {
            if(document.getElementById('passwordInput').value === "1234") {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadData();
            } else { alert("خطأ في كلمة المرور"); }
        };
        window.logout = function() { location.reload(); };

        window.showSection = function(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id + 'Section').classList.add('active');
            event.target.classList.add('active');
        };

        function loadData() {
            onValue(ref(db, 'products'), (snapshot) => {
                const products = snapshot.val();
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';
                if(products) {
                    Object.keys(products).forEach(key => {
                        const p = products[key];
                        tbody.innerHTML += `
                            <tr>
                                <td><img src="${p.images ? p.images[0] : ''}" class="preview-img"></td>
                                <td>${p.name}</td>
                                <td>${Number(p.price).toLocaleString()} د.ع</td>
                                <td>${p.categoryName || 'عام'}</td>
                                <td>
                                    <button class="btn-primary" onclick="openEditModal('${key}')" style="padding:5px 10px;">تعديل</button>
                                    <button class="btn-danger" onclick="deleteItem('products/${key}')" style="padding:5px 10px;">حذف</button>
                                </td>
                            </tr>`;
                    });
                }
            });

            onValue(ref(db, 'categories'), (snapshot) => {
                const categories = snapshot.val();
                const addSelect = document.getElementById('productCategory');
                const editSelect = document.getElementById('editProductCategory');
                const list = document.getElementById('categoriesList');
                addSelect.innerHTML = ''; editSelect.innerHTML = ''; list.innerHTML = '';
                if(categories) {
                    Object.keys(categories).forEach(key => {
                        const name = categories[key].name;
                        const opt = `<option value="${key}">${name}</option>`;
                        addSelect.innerHTML += opt; editSelect.innerHTML += opt;
                        list.innerHTML += `<div style="background:white; padding:10px; margin-bottom:5px; display:flex; justify-content:space-between; border:1px solid #ddd; border-radius:8px">
                            <span>${name}</span>
                            <button class="btn-danger" onclick="deleteItem('categories/${key}')">حذف</button>
                        </div>`;
                    });
                }
            });
        }

        // الإضافة
        document.getElementById('addProductForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "جاري الحفظ...";
            const files = document.getElementById('productImages').files;
            const imageUrls = [];
            for (let file of files) { imageUrls.push(await toBase64(file)); }
            const catSelect = document.getElementById('productCategory');
            const data = {
                name: document.getElementById('productName').value,
                price: document.getElementById('productPrice').value,
                quantity: document.getElementById('productQuantity').value,
                description: document.getElementById('productDesc').value,
                category: catSelect.value,
                categoryName: catSelect.options[catSelect.selectedIndex].text,
                images: imageUrls
            };
            push(ref(db, 'products'), data).then(() => {
                alert("تمت الإضافة!"); this.reset(); document.getElementById('imagePreview').innerHTML = '';
                btn.disabled = false; btn.innerText = "إضافة المنتج";
            });
        };

        // التعديل - فتح المودال مع الصور القديمة
        window.openEditModal = function(id) {
            onValue(ref(db, 'products/' + id), (snapshot) => {
                const p = snapshot.val();
                if(p) {
                    document.getElementById('editProductId').value = id;
                    document.getElementById('editProductName').value = p.name;
                    document.getElementById('editProductPrice').value = p.price;
                    document.getElementById('editProductQuantity').value = p.quantity || 0;
                    document.getElementById('editProductDesc').value = p.description || '';
                    document.getElementById('editProductCategory').value = p.category;
                    
                    const preview = document.getElementById('editImagePreview');
                    preview.innerHTML = '';
                    if(p.images) {
                        p.images.forEach(img => {
                            preview.innerHTML += `<img src="${img}" class="preview-img" style="border: 2px solid var(--secondary-color);">`;
                        });
                    }
                    document.getElementById('editModal').classList.add('active');
                }
            }, { once: true });
        };

        window.closeEditModal = function() { document.getElementById('editModal').classList.remove('active'); };

        document.getElementById('editProductForm').onsubmit = async function(e) {
            e.preventDefault();
            const btn = document.getElementById('updateBtn');
            const id = document.getElementById('editProductId').value;
            btn.disabled = true; btn.innerText = "جاري التحديث...";

            const files = document.getElementById('editProductImages').files;
            const catSelect = document.getElementById('editProductCategory');
            let updatedData = {
                name: document.getElementById('editProductName').value,
                price: document.getElementById('editProductPrice').value,
                quantity: document.getElementById('editProductQuantity').value,
                description: document.getElementById('editProductDesc').value,
                category: catSelect.value,
                categoryName: catSelect.options[catSelect.selectedIndex].text
            };

            if (files.length > 0) {
                const imageUrls = [];
                for (let file of files) { imageUrls.push(await toBase64(file)); }
                updatedData.images = imageUrls;
            }

            update(ref(db, 'products/' + id), updatedData).then(() => {
                alert("تم التعديل!"); closeEditModal();
                btn.disabled = false; btn.innerText = "حفظ التغييرات";
            });
        };

        document.getElementById('addCategoryForm').onsubmit = function(e) {
            e.preventDefault();
            push(ref(db, 'categories'), { name: document.getElementById('categoryName').value }).then(() => this.reset());
        };

        window.deleteItem = function(path) { if(confirm("هل أنت متأكد؟")) remove(ref(db, path)); };

        // معاينة الصور الجديدة عند الاختيار
        function setupPreview(inputId, previewId) {
            document.getElementById(inputId).onchange = function() {
                const preview = document.getElementById(previewId);
                preview.innerHTML = ''; // يمسح القديم ويعرض الجديد
                for(let file of this.files) {
                    const reader = new FileReader();
                    reader.onload = e => { preview.innerHTML += `<img src="${e.target.result}" class="preview-img">`; }
                    reader.readAsDataURL(file);
                }
            };
        }
        setupPreview('productImages', 'imagePreview');
        setupPreview('editProductImages', 'editImagePreview');

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>
</body>

</html>
